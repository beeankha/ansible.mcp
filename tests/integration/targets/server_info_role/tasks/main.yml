---
- name: Configure GitHub MCP server host (HTTP connection)
  ansible.builtin.add_host:
    name: github-mcp-server
    ansible_connection: ansible.mcp.mcp
    ansible_mcp_server_name: github-server
    ansible_mcp_bearer_token: "{{ github_mcp_pat }}"
    ansible_mcp_manifest_path: "{{ role_path }}/files/manifest.json"

- name: Run ansible.mcp.server_info against GitHub server (HTTP)
  ansible.mcp.server_info:
  register: github_result
  delegate_to: github-mcp-server

- name: Validate GitHub server_info response
  ansible.builtin.assert:
    that:
      - not github_result.failed | default(false)
      - github_result.server_info is defined
      - github_result.server_info.serverInfo is defined
      - github_result.server_info.serverInfo.name is defined
      - github_result.server_info.serverInfo.version is defined
    fail_msg: "GitHub server_info does not contain expected structure"

- name: Check if uvx is available for AWS IAM MCP server
  ansible.builtin.command: which uvx
  register: uvx_check
  changed_when: false
  failed_when: false
  check_mode: false

- name: Configure AWS IAM MCP server host (stdio connection)
  ansible.builtin.add_host:
    name: aws-iam-mcp-server
    ansible_connection: ansible.mcp.mcp
    ansible_mcp_server_name: aws-iam-mcp-server
    ansible_mcp_server_args:
      - --readonly
    ansible_mcp_server_env:
      AWS_REGION: us-east-1
      AWS_PROFILE: default
    ansible_mcp_manifest_path: "{{ role_path }}/files/manifest.json"
  when: uvx_check.rc == 0

- name: Run ansible.mcp.server_info against AWS IAM server (stdio)
  ansible.mcp.server_info:
  register: aws_result
  delegate_to: aws-iam-mcp-server
  when: uvx_check.rc == 0

- name: Validate AWS server_info response
  ansible.builtin.assert:
    that:
      - not aws_result.failed | default(false)
      - aws_result.server_info is defined
      - aws_result.server_info.serverInfo is defined
      - aws_result.server_info.serverInfo.name is defined
      - aws_result.server_info.serverInfo.version is defined
    fail_msg: "AWS server_info does not contain expected structure"
  when: uvx_check.rc == 0
